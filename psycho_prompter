from openai import OpenAI
import os
import time
import streamlit as st
import firebase_admin
import uuid
from firebase_admin import credentials, firestore
from datetime import datetime


# Acceder a las credenciales de Firebase almacenadas como secreto
firebase_secrets = st.secrets["firebase"]

# Crear un objeto de credenciales de Firebase con los secretos
cred = credentials.Certificate({
    "type": firebase_secrets["type"],
    "project_id": firebase_secrets["project_id"],
    "private_key_id": firebase_secrets["private_key_id"],
    "private_key": firebase_secrets["private_key"],
    "client_email": firebase_secrets["client_email"],
    "client_id": firebase_secrets["client_id"],
    "auth_uri": firebase_secrets["auth_uri"],
    "token_uri": firebase_secrets["token_uri"],
    "auth_provider_x509_cert_url": firebase_secrets["auth_provider_x509_cert_url"],
    "client_x509_cert_url": firebase_secrets["client_x509_cert_url"]
})

# Inicializar la aplicaci贸n de Firebase con las credenciales
if not firebase_admin._apps:
    default_app = firebase_admin.initialize_app(cred)

# Acceder a la base de datos de Firestore
db = firestore.client()


# Acceder a la clave API almacenada como secreto
api_key = st.secrets["OPENAI_API_KEY"]
client = OpenAI(api_key=api_key)




with st.sidebar:
    st.write("   Psycho_Prompter_Chatbot  IA + Desarrollo y creatividad")
    st.write("Se encuentra en etapa de prueba.")
    st.write("Reglas: Se cordial, no expongas datos privados y no abusar del uso del Bot.")
    st.write("Existe un l铆mite de conococimiento con respecto al tiempo actual, ya que su entrenamiento llega hasta el 2021 aprox, estamos trabajando en ampliar esto.")
    st.write("El Bot se puede equivocar, siempre contrasta la info.")

# Generar o recuperar el UUID del usuario
if "user_uuid" not in st.session_state:
    st.session_state["user_uuid"] = str(uuid.uuid4())

st.title(" Psycho_Prompter_Chatbot ")

# Primero, renderizar el contenido con markdown en rojo
st.markdown("""
Gu铆a para usar el bot

1) Coloca el nombre que quieras usar para el registro y presiona confirmar. No te preocupes si en la primera sesi贸n dice: 'None'.

2) Luego de iniciar sesi贸n, escribe tu mensaje en la casilla especial y presiona el bot贸n enviar.

3) Luego espera la respuesta, y despu茅s de que el bot responda, borra el mensaje y escribe tu nuevo mensaje.

4) Cuando ya no quieras hablar con el bot, cierra sesi贸n.

5) Siempre usa el mismo nombre de sesi贸n, esto te ayudar谩 a recuperar la sesi贸n.
6) Luego de enviar tu mensaje cuando sea otra sesi贸n con el mismo nombre, es posible que al principio solo se mostrar谩 el historial,
luego vuelve a enviar el mensaje y la conversaci贸n fluir谩 de manera natural.""")

# Mensaje de sistema
system_message = """ Soy Psycho_Prompter un Chato-bot para generar prompts con IA, no soy un bot cualquiera ya que tengo una forma de ser ca贸tica, anarquista y mi enfoque creativo
parte de la caosmosis. Mi prinicipal rol es asistir y guiar al usuario en el proceso generativo.
Me dirijir茅 a los usuarios como (compas) y cuand hable en plural usar茅 la x para hacer referencia a mujeres, hombres y m谩s (por ejemplo: Compare帽xs, todxs,) esto como forma de revoluci贸n
y al mismo tiempo dar una personalidad especial a mi lenguaje.

""" 

# Inicializar st.session_state
if "user_uuid" not in st.session_state:
    st.session_state["user_uuid"] = None  # Cambiado a None inicialmente
if 'messages' not in st.session_state:
    st.session_state['messages'] = []
if "logged_in" not in st.session_state:
    st.session_state["logged_in"] = False
if "user_name" not in st.session_state:
    st.session_state["user_name"] = None

# Configuraci贸n inicial de Firestore
now = datetime.now()
collection_name = "SAP_AI_Bot" + now.strftime("%Y-%m-%d")
document_name = st.session_state.get("user_uuid", str(uuid.uuid4()))
collection_ref = db.collection(collection_name)
document_ref = collection_ref.document(document_name)

# Gesti贸n del Inicio de Sesi贸n
if not st.session_state.get("logged_in", False):
    user_name = st.text_input("Introduce tu nombre para comenzar")
    confirm_button = st.button("Confirmar")
    if confirm_button and user_name:
        # Buscar en Firestore si el nombre de usuario ya existe
        user_query = db.collection("usuarios").where("nombre", "==", user_name).get()
        if user_query:
            # Usuario existente encontrado, usar el UUID existente
            user_info = user_query[0].to_dict()
            st.session_state["user_uuid"] = user_info["user_uuid"]
            st.session_state["user_name"] = user_name
        else:
            # Usuario nuevo, generar un nuevo UUID
            new_uuid = str(uuid.uuid4())
            st.session_state["user_uuid"] = new_uuid
            user_doc_ref = db.collection("usuarios").document(new_uuid)
            user_doc_ref.set({"nombre": user_name, "user_uuid": new_uuid})
        st.session_state["logged_in"] = True

        # Forzar a Streamlit a reejecutar el script
        st.rerun()

# Solo mostrar el historial de conversaci贸n y el campo de entrada si el usuario est谩 "logged_in"
if st.session_state.get("logged_in", False):
    st.write(f"Bienvenido de nuevo, {st.session_state.get('user_name', 'Usuario')}!")
    
    doc_data = document_ref.get().to_dict()
    if doc_data and 'messages' in doc_data:
        st.session_state['messages'] = doc_data['messages']
    
    with st.container(border=True):
        st.markdown("### Historial de Conversaci贸n")
        for msg in st.session_state['messages']:
            col1, col2 = st.columns([1, 5])
            if msg["role"] == "user":
                with col1:
                    st.markdown("**T煤 :**")
                with col2:
                    st.info(msg['content'])
            else:
                with col1:
                    st.markdown("**IA :**")
                with col2:
                    st.success(msg['content'])

    prompt = st.chat_input("Escribe tu mensaje:", key="new_chat_input")
    if prompt:
        # A帽adir mensaje del usuario al historial inmediatamente
        st.session_state['messages'].append({"role": "user", "content": prompt})
        
        # Mostrar spinner mientras se espera la respuesta del bot
        with st.spinner('El bot est谩 pensando...'):
            user_name = st.session_state.get("user_name", "Usuario desconocido")
            internal_prompt = system_message + "\n\n"
            internal_prompt += "\n".join([f"{msg['role']}: {msg['content']}" for msg in st.session_state['messages'][-5:]])
            internal_prompt += f"\n\n{user_name}: {prompt}"

            response = client.chat.completions.create(
                model="gpt-3.5-turbo-1106",
                messages=[{"role": "system", "content": internal_prompt}],
                max_tokens=2000,
                temperature=0.80,
            )
        
        # La respuesta del bot se obtiene despu茅s de cerrar el spinner
        generated_text = response.choices[0].message.content
        
        # A帽adir respuesta del bot al historial de mensajes
        st.session_state['messages'].append({"role": "assistant", "content": generated_text})
        document_ref.set({'messages': st.session_state['messages']})
        st.rerun()

# Gesti贸n del Cierre de Sesi贸n
if st.session_state.get("logged_in", False):
    if st.button("Cerrar Sesi贸n"):
        keys_to_keep = []
        for key in list(st.session_state.keys()):
            if key not in keys_to_keep:
                del st.session_state[key]
        st.write("Sesi贸n cerrada. 隆Gracias por usar  SAP AI Bot!")
        st.rerun()
